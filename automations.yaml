- id: "1665379421018"
  alias: Notify - Low battery level for all battery sensors (blueprint)
  description: ""
  use_blueprint:
    path: Sbyx/low-battery-level-detection-notification-for-all-battery-sensors.yaml
    input:
      actions:
        - service: notify.mobile_app_patricks_iphone_13
          data:
            message: Low battery warning for {{sensors}}
      threshold: 80
- id: "1665816721948"
  alias: Notify - workshop door opened
  description: ""
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.workshop_door_contact
      from: "off"
      to: "on"
  condition:
    - condition: state
      entity_id: person.patrick
      state: not_home
  action:
    - service: notify.mobile_app_patricks_iphone_13
      data:
        title: Door opened
        message: "{{ trigger.to_state.name }} just opened

          "
        data:
          push:
            sound: Workshop door opened.wav
            interruption-level: time-sensitive
      enabled: true
  mode: single
- id: "1667210675939"
  alias: Motion - Hallway turn lights on for 2 mins 11pm-6am
  description: Triggered by hallway sensor between 11pm-6am
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.hallway_sensor_occupancy
      to: "on"
      from: "off"
  condition:
    - condition: time
      before: 06:00:00
      after: "23:00:00"
      weekday:
        - mon
        - tue
        - wed
        - thu
        - fri
        - sat
        - sun
      enabled: false
    - condition: state
      entity_id: input_boolean.sleep_mode
      state: "on"
  action:
    - service: light.turn_on
      data:
        brightness_pct: 5
      target:
        entity_id:
          - light.led_strip_kitchen_kicker
    - service: light.turn_on
      data:
        brightness_pct: 10
      target:
        entity_id: light.led_strip_front_hall_dimmer
    - delay:
        hours: 0
        minutes: 2
        seconds: 45
        milliseconds: 0
    - service: light.turn_off
      data: {}
      target:
        entity_id:
          - light.led_strip_kitchen_kicker
          - light.led_strip_front_hall_dimmer
  mode: single
- id: "1667473720137"
  alias: Blinds close at sunset
  description: ""
  trigger:
    - platform: numeric_state
      entity_id: sun.sun
      attribute: elevation
      below: -7.3
  condition: []
  action:
    - service: tts.cloud_say
      data:
        message: Blinds are about to close
        entity_id: media_player.homepod_mini_back_lounge
        cache: true
    - delay:
        hours: 0
        minutes: 0
        seconds: 5
        milliseconds: 0
    - service: cover.close_cover
      data: {}
      target:
        entity_id: cover.all_blinds
  mode: single
- id: "1667474758731"
  alias: Blinds open at 6:30AM
  description: ""
  trigger:
    - platform: numeric_state
      entity_id: sun.sun
      attribute: elevation
      above: 3
      enabled: false
    - platform: time
      at: 06:30:00
  condition:
    - condition: state
      entity_id: binary_sensor.workday_sensor
      state: "on"
  action:
    - service: tts.cloud_say
      data:
        entity_id: media_player.homepod_mini_back_lounge
        message: Blinds are about to open
    - delay:
        hours: 0
        minutes: 0
        seconds: 5
        milliseconds: 0
    - service: cover.open_cover
      data: {}
      target:
        entity_id: cover.all_blinds
  mode: single
- id: "1667994480908"
  alias: Notify - Garage door opened + still open every 15mins
  description: Repeat every 15 minutes if left open
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.garage_door_bottom_magnet
      to: "on"
      for:
        hours: 0
        minutes: 15
        seconds: 0
  condition:
    - condition: state
      state: not_home
      entity_id: person.patrick
      enabled: false
    - condition: state
      entity_id: input_boolean.garage_door_alerts
      state: "on"
  action:
    - service: notify.mobile_app_patricks_iphone_13
      data:
        title: Garage Door!
        message:
          Garage door has been open for {{ (((trigger.for.seconds) | int) / 60)
          | round(0) }} minutes
    - service: tts.cloud_say
      data:
        entity_id:
          - media_player.homepod_mini_back_lounge
          - media_player.workshop_speaker
        message:
          Garage door has been open for {{ (((trigger.for.seconds) | int) / 60)
          | round(0) }} minutes
    - delay:
        hours: 0
        minutes: 15
        seconds: 0
        milliseconds: 0
    - repeat:
        while:
          - condition: and
            conditions:
              - condition: state
                entity_id: input_boolean.garage_door_alerts
                state: "on"
              - condition: state
                entity_id: binary_sensor.garage_door_bottom_magnet
                state: "on"
        sequence:
          - variables:
              action_disable: "{{ 'DISABLE_' ~ context.id }}"
          - service: notify.mobile_app_patricks_iphone_13
            data:
              title: Garage Door!
              message:
                '{{ trigger.to_state.name | replace(" Bottom Magnet","") }} has
                been open since {{ (trigger.to_state.last_updated) | as_timestamp | timestamp_custom(''%I:%M
                %p'') }}.'
              data:
                push:
                  sound: long_low_short_high.caf
                  interruption-level: time-sensitive
                actions:
                  - action: "{{ action_disable }}"
                    title: Disable these notifications
          - service: tts.cloud_say
            data:
              entity_id:
                - media_player.homepod_mini_back_lounge
                - media_player.workshop_speaker
              message:
                Garage door has been open since {{ (trigger.to_state.last_updated)
                | as_timestamp | timestamp_custom('%I:%M %p') }}.
          - wait_for_trigger:
              - platform: event
                event_type: mobile_app_notification_action
                event_data:
                  action: "{{ action_disable }}"
            timeout:
              hours: 0
              minutes: 1
              seconds: 0
              milliseconds: 0
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ wait.trigger.event.data.action == action_disable }}"
                sequence:
                  - service: input_boolean.turn_off
                    target:
                      entity_id:
                        - input_boolean.garage_door_alerts
                    data: {}
                  - stop: Stopped the repeat loop by user actionable notification
          - delay:
              hours: 0
              minutes: 14
              seconds: 0
              milliseconds: 0
  mode: restart
- id: "1668249041786"
  alias: Lights - on at sunset
  description: "just before sunset when sun elevation < 5° "
  trigger:
    - platform: numeric_state
      entity_id: sun.sun
      attribute: elevation
      below: 5
  condition: []
  action:
    - service: light.turn_on
      data: {}
      target:
        entity_id:
          - light.stairs_light
          - light.back_lounge_pendant
          - light.kitchen_pendant
          - light.rear_garden_lights
          - light.front_garden_lights
          - light.pool_light_controller_pool_lights
    - service: light.turn_on
      data:
        brightness_pct: 35
        kelvin: 2900
      target:
        entity_id:
          - light.back_lounge_sideboard_lamp
    - service: light.turn_on
      data:
        brightness_pct: 35
        color_temp: 358
      target:
        entity_id:
          - light.front_hall_lamp
    - service: light.turn_on
      data:
        brightness_pct: 25
      target:
        entity_id: light.led_strip_front_hall_dimmer
    - service: light.turn_on
      data:
        color_temp: 358
        brightness_pct: 18
      target:
        entity_id: light.front_lounge_sideboard_lamp
    - service: light.turn_on
      data:
        brightness_pct: 12
      target:
        entity_id: light.led_strip_kitchen_kicker
    - service: light.turn_on
      data:
        brightness_pct: 35
      target:
        entity_id: light.led_strip_fire_pit_dimmer
    - service: light.turn_on
      data:
        brightness_pct: 50
        color_temp: 358
      target:
        entity_id:
          - light.lamp_rhs_fireplace
      enabled: false
    - service: light.turn_on
      data:
        effect: "{{ range(0,6) | random | int }}"
        brightness_pct: 30
      target:
        entity_id: light.twinkly_back_lounge
    - service: light.turn_on
      target:
        entity_id:
          - light.inflatable_santa
        device_id: []
        area_id: []
      data: {}
    - if:
        - condition: state
          entity_id: input_boolean.sleep_mode
          state: "off"
      then:
        - service: light.turn_on
          data:
            brightness_pct: 25
          target:
            entity_id: light.bedside_lamp_kathleen
  mode: single
- id: "1668760849772"
  alias:
    "Lights - Front yard lights ON when front door open / CCTV line cross / garage
    door opened "
  description: ""
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.ds_7608ni_i2_8p0820220623ccrrk17144184wcvu_1_linedetection
      to: "on"
    - platform: state
      entity_id:
        - binary_sensor.ds_7608ni_i2_8p0820220623ccrrk17144184wcvu_1_fielddetection
      to: "on"
    - platform: state
      entity_id:
        - binary_sensor.garage_door_bottom_magnet
      to: "on"
    - platform: state
      entity_id:
        - binary_sensor.front_door_aqara_contact
      to: "on"
    - platform: state
      entity_id:
        - cover.pedestrian_gate
      to: open
    - platform: state
      entity_id:
        - binary_sensor.driveway_light_beam
      to: "on"
    - platform: state
      entity_id:
        - cover.driveway_gate
      to: opening
  condition:
    - condition: sun
      after: sunset
      before: sunrise
    - condition: state
      entity_id: input_boolean.disable_front_yard_motion_lights
      state: "off"
  action:
    - service: light.turn_on
      data: {}
      target:
        entity_id: light.front_yard_lights
    - delay:
        hours: 0
        minutes: 7
        seconds: 0
        milliseconds: 0
    - service: light.turn_off
      data: {}
      target:
        entity_id:
          - light.front_stone_up_down
          - light.front_porch
          - light.meterbox_bunker
          - light.front_north_side_flood
    - if:
        - condition: or
          conditions:
            - condition: time
              after: input_datetime.lights_off_time_1
            - condition: sun
              before: sunrise
      then:
        - service: light.turn_off
          data: {}
          target:
            entity_id: light.front_garden_lights
  mode: restart
- id: "1668816141842"
  alias: Motion - Workshop downlight
  description: Any time of day
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.workshop_ceiling_motion_occupancy
      from: "off"
      to: "on"
      enabled: true
      id: motion detected
    - platform: state
      entity_id:
        - binary_sensor.hlk_ld1115h_mmwave_occupancy_or_movement
      to: "on"
      id: motion detected
      enabled: false
    - platform: state
      entity_id:
        - binary_sensor.hlk_ld1115h_mmwave_occupancy_or_movement
      to: "off"
      for:
        hours: 0
        minutes: 4
        seconds: 0
      enabled: false
    - platform: state
      entity_id:
        - binary_sensor.workshop_ceiling_motion_occupancy
      to: "off"
      for:
        hours: 0
        minutes: 4
        seconds: 0
      enabled: true
  condition: []
  action:
    - if:
        - condition: trigger
          id:
            - motion detected
      then:
        - if:
            - condition: state
              entity_id: input_boolean.sleep_mode
              state: "on"
          then:
            - service: light.turn_on
              data:
                brightness_pct: 33
              target:
                entity_id: light.led_strip_workshop_shelf_dimmer
          else:
            - service: light.turn_on
              data:
                brightness_pct: 100
              target:
                entity_id:
                  - light.workshop_downlight
                  - light.led_strip_workshop_shelf_dimmer
      else:
        - service: light.turn_off
          data: {}
          target:
            entity_id:
              - light.workshop_downlight
              - light.led_strip_workshop_shelf_dimmer
  mode: restart
- id: "1668855016367"
  alias: Auto off - all lights and power when last person leaves house
  description: ""
  trigger:
    - platform: numeric_state
      entity_id: zone.home
      below: 1
  condition:
    - condition: state
      entity_id: sun.sun
      state: above_horizon
  action:
    - if:
        - condition: state
          entity_id: switch.workshop_power_strip
          state: "on"
      then:
        - service: notify.mobile_app_patricks_iphone_13
          data:
            message:
              Workshop power strip turned off for safety when last person left
              home
            title: Workshop power strip!
        - service: switch.turn_off
          data: {}
          target:
            entity_id: switch.workshop_power_strip
    - if:
        - condition: state
          entity_id: light.all_lights
          state: "on"
      then:
        - service: notify.mobile_app_patricks_iphone_13
          data:
            title: All lights off!
            message:
              Turned off {{ states('sensor.number_of_lights_on') }} lights when
              last person left home.
        - service: light.turn_off
          data: {}
          target:
            entity_id: light.all_lights
  mode: single
- id: "1668936398884"
  alias: Lights - Back yard on CCTV intrusion back yard / alfresco
  description: When sun elevation is < 0°
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.ds_7608ni_i2_8p0820220623ccrrk17144184wcvu_3_fielddetection
      to: "on"
    - platform: state
      entity_id:
        - binary_sensor.ds_7608ni_i2_8p0820220623ccrrk17144184wcvu_2_fielddetection
  condition:
    - condition: numeric_state
      entity_id: sun.sun
      attribute: elevation
      below: 0
    - condition: state
      entity_id: input_boolean.sleep_mode
      state: "on"
      enabled: false
  action:
    - service: light.turn_on
      data: {}
      target:
        entity_id:
          - light.back_yard_lights
    - delay:
        hours: 0
        minutes: 5
        seconds: 0
        milliseconds: 0
    - if:
        - condition: state
          entity_id: input_boolean.sleep_mode
          state: "on"
      then:
        - service: light.turn_off
          data: {}
          target:
            entity_id:
              - light.back_yard_lights
      else:
        - service: light.turn_off
          data: {}
          target:
            entity_id:
              - light.alfresco_downlights
              - light.pool_perimeter_downlights
              - light.rear_flood_light
  mode: restart
- id: "1668938565078"
  alias: Light - Alfresco when alfresco door opens at night
  description: When sun elevation < 0°
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.alfresco_door_contact
      to: "on"
  condition:
    - condition: numeric_state
      entity_id: sun.sun
      attribute: elevation
      below: 0
  action:
    - service: light.turn_on
      data: {}
      target:
        entity_id: light.alfresco_downlights
    - delay:
        hours: 0
        minutes: 7
        seconds: 0
        milliseconds: 0
    - service: light.turn_off
      data: {}
      target:
        entity_id: light.alfresco_downlights
  mode: restart
- id: "1669290456260"
  alias: Notify - Daily solar production report
  description: ""
  trigger:
    - platform: time
      at: "20:30:00"
  condition: []
  action:
    - service: notify.mobile_app_patricks_iphone_13
      data:
        title: Solar generated daily report!
        message:
          Today you generated {{ (states('sensor.solarnet_energy_day') | float)
          | round(1) }} kWh.
        data:
          actions:
            - action: URI
              title: View solar page
              uri: /lovelace/solar
    - service: notify.lg_webos_smart_tv
      data:
        title: Solar report
        message:
          "Solar energy: Today you generated {{ (states('sensor.solarnet_energy_day')
          | float) | round(1) }} kWh."
  mode: single
- id: "1669522933161"
  alias: Soldering - workshop soldering irons OFF when NO MOTION
  description: ""
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.workshop_ceiling_motion_occupancy
      to: "off"
      for:
        hours: 0
        minutes: 10
        seconds: 0
      enabled: false
    - platform: state
      entity_id:
        - binary_sensor.ld2410_mmwave_presence
      to: "off"
      for:
        hours: 0
        minutes: 10
        seconds: 0
    - platform: state
      entity_id:
        - switch.workshop_power_strip
      to: "on"
      for:
        hours: 0
        minutes: 30
        seconds: 0
      enabled: true
  condition:
    - condition: state
      entity_id: switch.workshop_power_strip
      state: "on"
  action:
    - service: switch.turn_off
      data: {}
      target:
        entity_id: switch.workshop_power_strip
    - service: notify.mobile_app_patricks_iphone_13
      data:
        title: Workshop soldering iron
        message:
          "Turned off soldering iron becuase\n{% if \"occupancy\" in trigger.entity_id
          -%}\n  no motion for 10 minutes\n{% elif \"power_strip\" in trigger.entity_id
          -%}\n  on for more than 30 minutes\n{% endif %}"
    - if:
        - condition: time
          before: "21:30:00"
          after: 07:00:00
      then:
        - service: tts.cloud_say
          data:
            message:
              "Turned off soldering iron becuase\n{% if \"occupancy\" in trigger.entity_id
              -%}\n  no motion for 10 minutes\n{% elif \"power_strip\" in trigger.entity_id
              -%}\n  on for more than 30 minutes\n{% endif %}"
            entity_id: media_player.workshop_speaker
  mode: single
- id: "1669532232781"
  alias: Soldering - Workshop light to RED when soldering iron turned ON
  description: ""
  trigger:
    - platform: state
      entity_id:
        - switch.workshop_power_strip
      to: "on"
  condition: []
  action:
    - service: light.turn_on
      target:
        entity_id: light.wled_workshop
      data: {}
      enabled: false
    - service: select.select_option
      target:
        entity_id: select.wled_workshop_preset
      data:
        option: soldering on
      enabled: false
    - service: light.turn_on
      data:
        color_name: red
        brightness_pct: 70
      target:
        entity_id: light.workshop_rgb_light
  mode: single
- id: "1669533897582"
  alias:
    Soldering - Workshop light to BLUE for 2mins then OFF when soldering iron
    turned OFF
  description: ""
  trigger:
    - platform: state
      entity_id:
        - switch.workshop_power_strip
      to: "off"
  condition: []
  action:
    - service: light.turn_on
      target:
        entity_id:
          - light.wled_workshop
      data: {}
      enabled: false
    - service: select.select_option
      target:
        entity_id: select.wled_workshop_preset
      data:
        option: soldering off
      enabled: false
    - service: number.set_value
      target:
        entity_id: number.wled_workshop_speed
      data:
        value: "125"
      enabled: false
    - service: light.turn_on
      data:
        rgb_color:
          - 82
          - 171
          - 255
        brightness_pct: 50
      target:
        entity_id: light.workshop_rgb_light
      alias: "Light: Workshop RGB light to blue"
    - delay:
        hours: 0
        minutes: 2
        seconds: 0
        milliseconds: 0
    - service: light.turn_off
      data: {}
      target:
        entity_id: light.workshop_rgb_light
    - service: select.select_option
      target:
        entity_id: select.wled_workshop_preset
      data:
        option: Noise 2
      enabled: false
  mode: restart
- id: "1669545204042"
  alias: Button - Patrick's bedside
  description: ""
  use_blueprint:
    path: CrazyCoder/zigbee2mqtt_aqara_wireless_switch.yaml
    input:
      action_sensor: sensor.button_patrick_bedside_action
      press_single:
        - service: light.toggle
          data:
            brightness_pct: 7
          target:
            entity_id:
              - light.led_strip_kitchen_kicker
      press_double:
        - service: light.turn_on
          data: {}
          target:
            entity_id:
              - light.front_yard_lights
              - light.back_yard_lights
              - light.courtyard_flood_light
      press_hold:
        - service: light.turn_off
          data: {}
          target:
            entity_id: light.all_lights
        - service: switch.turn_off
          data: {}
          target:
            entity_id: switch.19_rack_fans
        - if:
            - condition: state
              entity_id: binary_sensor.workshop_window_contact
              state: "on"
          then:
            - service: notify.mobile_app_patricks_iphone_13
              data:
                message: Workshop window is open
                title: Window open
        - if:
            - condition: state
              entity_id: binary_sensor.alfresco_door_contact
              state: "on"
          then:
            - service: notify.mobile_app_patricks_iphone_13
              data:
                message: Alfresco door is open
                title: Door open
        - if:
            - condition: state
              entity_id: binary_sensor.front_door_aqara_contact
              state: "on"
          then:
            - service: notify.mobile_app_patricks_iphone_13
              data:
                message: Front door is open
                title: Door open
        - if:
            - condition: time
              after: "21:00:00"
              before: 06:00:00
          then:
            - service: input_boolean.turn_on
              data: {}
              target:
                entity_id: input_boolean.sleep_mode
            - service: notify.mobile_app_patricks_iphone_13
              data:
                message: Sleep mode turned on with long press of Patrick's bedside button
                title: Sleep mode ON
        - service: switch.turn_off
          data: {}
          target:
            entity_id: switch.gas_heater
- id: "1669631569864"
  alias: Lights - Front yard lights ON when anyone arrives home
  description: ""
  trigger:
    - platform: state
      entity_id:
        - person.patrick
      to: home
    - platform: state
      entity_id:
        - person.kathleen
      to: home
  condition:
    - condition: numeric_state
      entity_id: sun.sun
      attribute: elevation
      below: 5
  action:
    - service: light.turn_on
      data: {}
      target:
        entity_id:
          - light.front_yard_lights
          - light.garage_downlights
    - service: automation.trigger
      data:
        skip_condition: true
      target:
        entity_id: automation.lights_on_at_sunset
    - delay:
        hours: 0
        minutes: 7
        seconds: 0
        milliseconds: 0
    - service: light.turn_off
      data: {}
      target:
        entity_id:
          - light.front_stone_up_down
          - light.front_porch
          - light.meterbox_bunker
          - light.front_north_side_flood
          - light.garage_downlights
          - light.front_lounge_sideboard_lamp
    - if:
        - condition: or
          conditions:
            - condition: time
              after: input_datetime.lights_off_time_1
            - condition: sun
              before: sunrise
      then:
        - service: light.turn_off
          data: {}
          target:
            entity_id:
              - light.front_garden_lights
              - light.rear_garden_lights
    - if:
        - condition: or
          conditions:
            - condition: time
              after: input_datetime.lights_off_time_2
            - condition: sun
              before: sunrise
      then:
        - service: light.turn_off
          data: {}
          target:
            entity_id:
              - light.pool_light_controller_pool_lights
              - light.led_strip_fire_pit_dimmer
  mode: restart
- id: "1669632348299"
  alias: Motion - Butler's pantry lights ON
  description: Bright during day, dim at night
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.butlers_sensor_occupancy
      to: "on"
      from: "off"
  condition: []
  action:
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: time
                  before: "23:00:00"
                  after: 06:00:00
                  enabled: false
                - condition: state
                  entity_id: input_boolean.sleep_mode
                  state: "off"
          sequence:
            - service: light.turn_on
              data:
                brightness_pct: 40
              target:
                entity_id:
                  - light.butlers_downlight
                  - light.led_strip_butlers_overhead_cupboards
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: input_boolean.sleep_mode
                  state: "on"
                - condition: time
                  after: "23:00:00"
                  before: 06:00:00
                  enabled: false
          sequence:
            - service: light.turn_on
              data:
                brightness_pct: 2
              target:
                entity_id: light.led_strip_butlers_overhead_cupboards
    - wait_for_trigger:
        - platform: state
          entity_id:
            - binary_sensor.butlers_sensor_occupancy
          from: "on"
          to: "off"
    - delay:
        hours: 0
        minutes: 4
        seconds: 0
        milliseconds: 0
    - service: light.turn_off
      data: {}
      target:
        entity_id:
          - light.butlers_downlight
          - light.led_strip_butlers_overhead_cupboards
  mode: restart
- id: "1669710613722"
  alias: Google say - person arrived home
  description: ""
  trigger:
    - platform: state
      entity_id:
        - person.kathleen
        - person.patrick
      to: home
  condition:
    - condition: state
      entity_id: input_boolean.sleep_mode
      state: "off"
  action:
    - service: tts.cloud_say
      data:
        entity_id:
          - media_player.homepod_mini_back_lounge
          - media_player.workshop_speaker
        message: "{{ trigger.entity_id | replace('person.', '') }} is home"
  mode: single
- id: "1669888397242"
  alias: Notify - Leaving home and a door left open
  description: ""
  trigger:
    - platform: state
      entity_id:
        - zone.home
      to: "0"
  condition:
    - condition: or
      conditions:
        - condition: state
          entity_id: binary_sensor.alfresco_door_contact
          state: "on"
        - condition: state
          entity_id: binary_sensor.front_door_aqara_contact
          state: "on"
  action:
    - service: notify.patrick_and_kathleen
      data:
        title: Security alert!
        message:
          "{% set doors = [\n   states.binary_sensor.alfresco_door_contact,\n
          \  states.binary_sensor.front_door_aqara_contact ]\n   | selectattr('state',
          'eq', 'on')\n   | map(attribute='name') | list %}\n  {% set qty = doors |
          count %}\n  {% if qty == 0 %}\n    Everything is closed.\n  {% else %}\n    You
          just left home but the following door{{ 's are' if qty > 1 else ' is'}} open:
          {{ doors | join(', ') | replace(\"aqara contact\", \"\") }}\n  {% endif %}"
        data:
          push:
            interruption-level: critical
  mode: single
- id: "1669961250496"
  alias: Notify - Door opened when nobody is home
  description: ""
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.alfresco_door_contact
        - binary_sensor.front_door_aqara_contact
        - binary_sensor.workshop_window_contact
      to: "on"
  condition:
    - condition: and
      conditions:
        - condition: state
          entity_id: person.patrick
          state: not_home
        - condition: state
          entity_id: person.kathleen
          state: not_home
      enabled: false
    - condition: numeric_state
      entity_id: zone.home
      below: 1
  action:
    - service: notify.mobile_app_patricks_iphone_13
      data:
        title: Intruder Alarm
        message:
          "Nobody is home and the {{ trigger.to_state.name }} door just opened!

          "
        data:
          push:
            sound:
              name:
                "{%- if \"Front\" in trigger.to_state.name -%}\n  US-EN-Morgan-Freeman-Front-Door-Opened.wav\n{%-
                elif \"Alfresco\" in trigger.to_state.name -%}\n  US-EN-Morgan-Freeman-Patio-Door-Opened.wav\n{%-
                endif -%}"
              critical: 1
              volume: 0.5
      enabled: false
    - service: notify.patrick_and_kathleen
      data:
        title: Intruder Alarm
        message:
          'Nobody is home and the {{ trigger.to_state.name | replace("aqara contact",
          "") }} just opened!

          '
        data:
          push:
            sound:
              name: default
              critical: 1
              volume: 0.5
  mode: single
- id: "1670040126536"
  alias: Notify - Garage door closed
  description: ""
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.garage_door_bottom_magnet
      to: "off"
      for:
        hours: 0
        minutes: 0
        seconds: 0
  condition:
    - condition: state
      state: not_home
      entity_id: person.patrick
      enabled: false
  action:
    - service: notify.mobile_app_patricks_iphone_13
      data:
        title: Garage Door!
        message:
          '{{ trigger.to_state.name | replace(" Bottom Magnet", "")}} has closed

          '
        data:
          push:
            sound: US-EN-Morgan-Freeman-Garage-Door-Closed.wav
            interruption-level: time-sensitive
      enabled: true
  mode: single
- id: "1670132740049"
  alias: Notify - Shelly getting hot (> 75°C)
  description: ""
  trigger:
    - platform: numeric_state
      entity_id:
        - sensor.alfresco_and_pool_perimeter_device_temperature
        - sensor.back_lounge_downlights_device_temperature
        - sensor.stairs_and_dining_device_temperature
        - sensor.dining_pendant_and_spare_device_temperature
        - sensor.front_hall_lower_device_temperature
        - sensor.front_hall_upper_device_temperature
        - sensor.front_lounge_device_temperature
        - sensor.kitchen_downlights_device_temperature
        - sensor.kitchen_pendant_and_spare_device_temperature
        - sensor.laundry_and_laundry_path_device_temperature
        - sensor.rear_flood_and_garden_lights_device_temperature
        - sensor.wir_downlight_device_temperature
        - sensor.butlers_downlight_temperature
        - sensor.garage_lights_temperature
        - sensor.lounge_pendant_temperature
        - sensor.workshop_downlight_device_temperature
      for:
        hours: 0
        minutes: 7
        seconds: 0
      above: 75
  condition: []
  action:
    - service: notify.mobile_app_patricks_iphone_13
      data:
        title: Shelly temperature
        message:
          'Shelly "{{ trigger.to_state.name | replace(" Device Temperature",
          "") }}" is {{ trigger.to_state.state }}°C. {{ ''\n'' -}} [Above trigger of
          {{ trigger.above }}°C for {{ (((trigger.for.seconds) | int) / 60) | round(0)
          }} minutes.]

          '
  mode: single
- id: "1670664345843"
  alias: "Notify - Calendar: Put bins out"
  description: ""
  trigger:
    - platform: calendar
      event: start
      offset: -0:0:0
      entity_id: calendar.rubbish_bins
  condition: []
  action:
    - service: notify.mobile_app_patricks_iphone_13
      data:
        title: Calendar notification
        message:
          Put out {{ trigger.calendar_event.summary }} for collection tomorrow
          morning. {{ trigger.calendar_event.start | as_timestamp | timestamp_custom('%I:%M
          %p') }}
    - service: tts.cloud_say
      data:
        entity_id:
          - media_player.homepod_mini_back_lounge
          - media_player.workshop_speaker
        message:
          Put out {{ trigger.calendar_event.summary }} for collection tomorrow
          morning.
  mode: queued
  max: 10
- id: "1671250102998"
  alias: Input booleans and counters - Reset and midnight
  description: ""
  trigger:
    - platform: time
      at: 00:00:00
  condition: []
  action:
    - service: input_boolean.turn_on
      data: {}
      target:
        entity_id:
          - input_boolean.grid_power_alert
          - input_boolean.garage_door_alerts
  mode: single
- id: "1671333862212"
  alias: Google say - Workshop CO2 level getting high
  description: ""
  trigger:
    - platform: numeric_state
      entity_id: sensor.co2_workshop_sensor
      above: 700
  condition:
    - condition: time
      before: "22:30:00"
      after: 07:00:00
  action:
    - service: fan.turn_on
      data: {}
      target:
        entity_id: fan.workshop_ceiling_fan
    - service: tts.cloud_say
      data:
        entity_id: media_player.workshop_speaker
        message:
          Workshop carbon dioxide getting high, it's above {{ trigger.above |
          float | round(0) }}
    - delay:
        hours: 0
        minutes: 5
        seconds: 0
        milliseconds: 0
    - repeat:
        until:
          - condition: numeric_state
            entity_id: sensor.co2_workshop_sensor
            below: 600
        sequence:
          - service: tts.cloud_say
            data:
              entity_id: media_player.workshop_speaker
              message:
                Workshop carbon dioxide is still high at {{ states('sensor.co2_workshop_sensor')
                | float | round(0) }}
          - delay:
              hours: 0
              minutes: 5
              seconds: 0
              milliseconds: 0
    - service: fan.turn_off
      data: {}
      target:
        entity_id: fan.workshop_ceiling_fan
  mode: single
- id: "1671357311185"
  alias: Rack fans - ON when rack > 28°C during daytime
  description: ""
  trigger:
    - platform: numeric_state
      entity_id: sensor.rack_temperature_ds18b20
      for:
        hours: 0
        minutes: 0
        seconds: 0
      above: 28
  condition:
    - condition: state
      entity_id: binary_sensor.workshop_ceiling_motion_occupancy
      state: "off"
      for:
        hours: 0
        minutes: 6
        seconds: 0
    - condition: time
      before: "21:30:00"
      after: 07:00:00
      alias: Time between 7am-9:30pm
  action:
    - service: fan.turn_on
      data: {}
      target:
        entity_id: fan.19_rack_fans
    - wait_template:
        "{{ (states('sensor.rack_temperature_ds18b20')|float - states('sensor.workshop_temperature_from_ac')|float)
        < 1.0 }}"
      continue_on_timeout: true
      timeout: 00:30:00
      enabled: false
    - wait_for_trigger:
        - platform: numeric_state
          entity_id: sensor.rack_temperature_ds18b20
          below: 25
        - platform: time
          at: "21:30:00"
    - service: fan.turn_off
      data: {}
      target:
        entity_id: fan.19_rack_fans
  mode: single
- id: "1671794465452"
  alias: Button - Jess bedside
  description: ""
  use_blueprint:
    path: CrazyCoder/zigbee2mqtt_aqara_wireless_switch.yaml
    input:
      action_sensor: sensor.button_jess_bedroom_action
      press_single:
        - service: select.select_option
          data:
            option:
              "{% set options = state_attr('select.jess_wled_mk2_preset', 'options')
              %} {% set current_option = states('select.jess_wled_mk2_preset') %} {%
              if current_option in options %}\n  {% set index = options.index(current_option)
              %}\n  {{ options[(index + 1) % (options | length)] }}\n{% else %}\n  {{
              options[0] }}\n{% endif %}\n"
          target:
            entity_id: select.jess_wled_mk2_preset
      press_double:
        - service: light.toggle
          data: {}
          target:
            entity_id: light.jess_wled_mk2
      press_hold:
        - service: light.turn_off
          data: {}
          target:
            entity_id: light.all_lights
        - service: switch.turn_off
          data: {}
          target:
            entity_id: switch.19_rack_fans
        - service: switch.turn_off
          data: {}
          target:
            entity_id: switch.gas_heater
- id: "1672344646174"
  alias: Lights - Side lights when CCTV line cross motion kitty cam
  description: When sun elevation is < 0°
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.ds_7608ni_i2_8p0820220623ccrrk17144184wcvu_5_linedetection
      to: "on"
  condition:
    - condition: numeric_state
      entity_id: sun.sun
      attribute: elevation
      below: 0
  action:
    - service: light.turn_on
      data: {}
      target:
        entity_id:
          - light.courtyard_flood_light
          - light.laundry_path_bunker_light
    - delay:
        hours: 0
        minutes: 7
        seconds: 0
        milliseconds: 0
    - service: light.turn_off
      data: {}
      target:
        entity_id:
          - light.courtyard_flood_light
          - light.laundry_path_bunker_light
  mode: restart
- id: "1674383678869"
  alias: Octoprint 50% complete
  description: ""
  trigger:
    - platform: numeric_state
      entity_id: sensor.octoprint_job_percentage
      above: 50
  condition: []
  action:
    - service: notify.mobile_app_patricks_iphone_13
      data:
        title: 3D Printer
        message: 3D print is 50% complete
  mode: single
- id: "1674384425478"
  alias: Octoprint - print finished
  description: ""
  trigger:
    - platform: state
      entity_id:
        - sensor.octoprint_current_state
      from: Printing
      to: Operational
  condition: []
  action:
    - service: notify.mobile_app_patricks_iphone_13
      data:
        title: 3D Printer
        message: Print has finished!
        data:
          push:
            sound: HummingbirdCompletion_Haptic.caf
            interruption-level: time-sensitive
    - service: fan.turn_off
      data: {}
      target:
        entity_id: fan.workshop_ceiling_fan
  mode: single
- id: "1674775378226"
  alias: Notify - leaving home and front door unlocked
  description: ""
  trigger:
    - platform: state
      entity_id:
        - zone.home
      to: "0"
  condition:
    - condition: state
      entity_id: lock.yale_smartlock_front_door
      state: unlocked
  action:
    - service: notify.mobile_app_patricks_iphone_13
      data:
        title: Security alert!
        message:
          You just left home but the front door is unlocked! Will try and lock
          it now, but please go home and double check it.
        data:
          push:
            interruption-level: critical
    - if:
        - condition: state
          entity_id: binary_sensor.front_door_aqara_contact
          state: "off"
          alias: Confirm front door is closed
      then:
        - service: lock.lock
          data: {}
          target:
            entity_id:
              - lock.yale_smartlock_front_door
  mode: single
- id: "1674880600732"
  alias: Notify - UPS battery low (not required, done by NUT UPS add-on option)
  description: ""
  trigger:
    - platform: numeric_state
      entity_id: sensor.ups_battery_charge
      below: 5
  condition: []
  action:
    - service: hassio.host_shutdown
      data: {}
    - service: notify.mobile_app_patricks_iphone_13
      data:
        title: Power Outage
        message:
          "UPS battery is below {{ trigger.below }}% so shutting down home assistant.

          "
  mode: single
- id: "1674888763657"
  alias: Notify - UPS state change
  description: ""
  trigger:
    - platform: event
      event_type: nut.ups_event
  condition: []
  action:
    - service: notify.mobile_app_patricks_iphone_13
      data_template:
        title: UPS {{ trigger.event.data.notify_type }}
        message:
          "{% set ups_msg = trigger.event.data.notify_msg | replace('UPS@localhost
          ', '') %} {% if 'battery' in ups_msg %}\n  Power outage! Running on UPS.\n{%
          elif 'line' in ups_msg %}\n  Power restored. UPS charging.\n{% endif -%} {%
          set ups_msg_2 = (states('sensor.ups_battery_charge') | int) %} Battery level
          is  {%- if ups_msg_2 is number %}\n  {{ ups_msg_2 }}%\n{% else %}\n  {{ states('sensor.ups_battery_charge')
          }}\n{% endif -%}\n"
  mode: single
- id: "1675156383173"
  alias: Notify - Leaving home and a window left open
  description: ""
  trigger:
    - platform: state
      entity_id:
        - zone.home
      to: "0"
  condition:
    - condition: or
      conditions:
        - condition: state
          entity_id: binary_sensor.workshop_window_contact
          state: "on"
  action:
    - service: notify.patrick_and_kathleen
      data:
        title: Security alert!
        message:
          "{% set windows = [\n   states.binary_sensor.workshop_window_contact
          ]\n   | selectattr('state', 'eq', 'on')\n   | map(attribute='name') | list
          %}\n  {% set qty = windows | count %}\n  {% if qty == 0 %}\n    Everything
          is closed.\n  {% else %}\n    You just left home but the following window{{
          's are' if qty > 1 else ' is' }} open: {{ windows | join(', ') }}\n  {% endif
          %}"
        data:
          push:
            interruption-level: critical
  mode: single
- id: "1675158213480"
  alias: Notify - Water leak
  description: ""
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.dishwasher_leak_sensor_water_leak
        - binary_sensor.washing_machine_leak_sensor_water_leak
      to: "on"
      from: "off"
  condition: []
  action:
    - service: tts.cloud_say
      data:
        entity_id:
          - media_player.homepod_mini_back_lounge
          - media_player.workshop_speaker
        message:
          Water is leaking in the {{ trigger.to_state.name | replace("leak sensor
          water leak", "") }}
    - service: notify.patrick_and_kathleen
      data:
        title: Water Leak!
        message:
          Water is leaking in the {{ trigger.to_state.name | replace("leak sensor
          water leak", "") }}
        data:
          push:
            interruption-level: critical
  mode: single
- id: "1676543396010"
  alias: Air con ON when HOT back lounge (people at home)
  description: ""
  trigger:
    - platform: numeric_state
      entity_id: climate.ac_back_lounge
      attribute: current_temperature
      above: 25
  condition:
    - condition: numeric_state
      entity_id: zone.home
      above: 0
    - condition: state
      entity_id: input_boolean.sleep_mode
      state: "off"
  action:
    - service: climate.turn_on
      data: {}
      target:
        entity_id: climate.ac
    - service: climate.set_temperature
      data:
        temperature: 24
        hvac_mode: cool
      target:
        entity_id: climate.ac
    - service: climate.set_hvac_mode
      data:
        hvac_mode: cool
      target:
        entity_id: climate.ac
      enabled: true
    - service: climate.set_fan_mode
      data:
        fan_mode: medium
      target:
        entity_id: climate.ac
    - service: notify.mobile_app_patricks_iphone_13
      data:
        title: Air con turned on (People at home)
        message:
          Turned on air conditioner as {{ trigger.to_state.name }} temperature
          is above {{ trigger.above }} and people are at home (i.e don't care if alrady
          importing power)
    - service: climate.set_temperature
      data:
        temperature: 24
      target:
        entity_id:
          - climate.ac_back_lounge
          - climate.ac_entry
          - climate.ac_front_lounge
          - climate.ac_jess_br
          - climate.ac_kitchen
          - climate.ac_master_br
          - climate.ac_spare_br
          - climate.ac_workshop
  mode: single
- id: "1677320260752"
  alias: Lights - garden lights off (first time of day)
  description: ""
  trigger:
    - platform: numeric_state
      entity_id: sun.sun
      attribute: elevation
      below: input_number.lights_off_sun_elevation_1
      enabled: false
    - platform: time
      at: input_datetime.lights_off_time_1
  condition: []
  action:
    - service: light.turn_off
      data: {}
      target:
        entity_id:
          - light.front_garden_lights
          - light.rear_garden_lights
          - light.front_lounge_sideboard_lamp
  mode: single
- id: "1677793921989"
  alias: Button - Kathleen's bedside
  description: ""
  use_blueprint:
    path: CrazyCoder/zigbee2mqtt_aqara_wireless_switch.yaml
    input:
      press_single:
        - service: light.toggle
          data: {}
          target:
            entity_id:
              - light.bedside_lamp_kathleen
      press_double:
        - service: light.turn_on
          data: {}
          target:
            entity_id:
              - light.front_yard_lights
              - light.back_yard_lights
              - light.courtyard_flood_light
      press_hold:
        - service: light.turn_off
          data: {}
          target:
            entity_id: light.all_lights
        - service: switch.turn_off
          data: {}
          target:
            entity_id: switch.19_rack_fans
        - if:
            - condition: state
              entity_id: binary_sensor.workshop_window_contact
              state: "on"
          then:
            - service: notify.mobile_app_patricks_iphone_13
              data:
                message: Workshop window is open
                title: Window open
        - if:
            - condition: state
              entity_id: binary_sensor.alfresco_door_contact
              state: "on"
          then:
            - service: notify.mobile_app_patricks_iphone_13
              data:
                message: Alfresco door is open
                title: Door open
        - if:
            - condition: state
              entity_id: binary_sensor.front_door_aqara_contact
              state: "on"
          then:
            - service: notify.mobile_app_patricks_iphone_13
              data:
                message: Front door is open
                title: Door open
        - if:
            - condition: time
              after: "21:00:00"
              before: 06:00:00
          then:
            - service: input_boolean.turn_on
              data: {}
              target:
                entity_id: input_boolean.sleep_mode
            - service: notify.mobile_app_patricks_iphone_13
              data:
                message: Sleep mode turned on with long press of Kathleen's bedside button
                title: Sleep mode ON
        - service: switch.turn_off
          data: {}
          target:
            entity_id: switch.gas_heater
      action_sensor: sensor.button_kathleen_bedside_action
- id: "1678303773548"
  alias: Light - Courtyard follows bunker light
  description: ""
  trigger:
    - platform: state
      entity_id:
        - light.laundry_path_bunker_light
      to: "on"
  condition: []
  action:
    - service: light.turn_on
      data: {}
      target:
        entity_id: light.courtyard_flood_light
    - wait_for_trigger:
        - platform: state
          entity_id:
            - light.laundry_path_bunker_light
          to: "off"
      timeout:
        hours: 0
        minutes: 20
        seconds: 0
        milliseconds: 0
    - service: light.turn_off
      data: {}
      target:
        entity_id:
          - light.courtyard_flood_light
          - light.laundry_path_bunker_light
  mode: single
- id: "1678589815500"
  alias: Notify - Grid power > 1.5kW, turn off with Actionable Notification
  description: ""
  trigger:
    - platform: numeric_state
      entity_id: sensor.solarnet_power_grid
      for:
        hours: 0
        minutes: 15
        seconds: 0
      above: 1.5
  condition:
    - condition: state
      entity_id: input_boolean.grid_power_alert
      state: "on"
  action:
    - repeat:
        until:
          - condition: or
            conditions:
              - condition: state
                entity_id: input_boolean.grid_power_alert
                state: "off"
              - condition: numeric_state
                entity_id: sensor.solarnet_power_grid
                below: 0.8
        sequence:
          - variables:
              action_disable: "{{ 'DISABLE_' ~ context.id }}"
          - service: notify.mobile_app_patricks_iphone_13
            data:
              title: Drawing excessive power from the grid for 15 mins!
              message:
                "Grid import power is now: {{ (states('sensor.solarnet_power_grid')
                | float)|round(1) }} kW"
              data:
                push:
                  sound: 3rdParty_Failure_Haptic.caf
                  interruption-level: time-sensitive
                actions:
                  - action: "{{ action_disable }}"
                    title: Disable these notifications
                  - action: URI
                    title: Go to energy page in HA
                    uri: /lovelace/solar
          - wait_for_trigger:
              - platform: event
                event_type: mobile_app_notification_action
                event_data:
                  action: "{{ action_disable }}"
            timeout:
              hours: 0
              minutes: 1
              seconds: 0
              milliseconds: 0
          - choose:
              - conditions: "{{ wait.trigger.event.data.action == action_disable }}"
                sequence:
                  - service: input_boolean.turn_off
                    target:
                      entity_id: input_boolean.grid_power_alert
                    data: {}
                  - stop: Stopped the repeat loop by user actionable notification
          - delay:
              hours: 0
              minutes: 14
              seconds: 0
              milliseconds: 0
  mode: restart
- id: "1678699026931"
  alias: Lights - pool & fire-pit lights off (second time of day)
  description: ""
  trigger:
    - platform: numeric_state
      entity_id: sun.sun
      attribute: elevation
      below: input_number.lights_off_sun_elevation_2
      enabled: false
    - platform: time
      at: input_datetime.lights_off_time_2
  condition: []
  action:
    - service: light.turn_off
      data: {}
      target:
        entity_id:
          - light.pool_light_controller_pool_lights
          - light.led_strip_fire_pit_dimmer
    - service: light.turn_off
      target:
        entity_id:
          - light.inflatable_santa
        device_id: []
        area_id: []
      data: {}
  mode: single
- id: "1679693076266"
  alias: Automatic - open garage and gate when PATRICK arrives home in when driving
  description: ""
  trigger:
    - platform: state
      entity_id:
        - person.patrick
      from: not_home
      to: home
      for:
        hours: 0
        minutes: 0
        seconds: 0
      enabled: false
    - platform: state
      entity_id:
        - device_tracker.patricks_iphone_bluetooth
      to: home
  condition:
    - condition: state
      entity_id: sensor.patricks_iphone_13_activity
      state: Automotive
    - condition: template
      value_template:
        "{{ now() - state_attr('automation.automatic_open_garage_and_gate_when_kathleen_arrives_home_in_when_driving',
        'last_triggered') > timedelta(seconds=30) }}"
  action:
    - delay:
        hours: 0
        minutes: 0
        seconds: 5
        milliseconds: 0
      enabled: false
    - service: script.open_gate_and_garage
      data: {}
  mode: single
- id: "1679726945385"
  alias: Automatic - open garage and gate when KATHLEEN arrives home in when driving
  description: ""
  trigger:
    - platform: state
      entity_id:
        - person.kathleen
      for:
        hours: 0
        minutes: 0
        seconds: 0
      from: not_home
      to: home
  condition:
    - condition: state
      entity_id: sensor.kathleens_iphone_activity
      state: Automotive
    - condition: template
      value_template:
        "{{ now() - state_attr('automation.automatic_open_garage_when_person_arrives_home_in_when_driving',
        'last_triggered') > timedelta(seconds=30) }}"
  action:
    - delay:
        hours: 0
        minutes: 0
        seconds: 5
        milliseconds: 0
      enabled: false
    - service: script.open_gate_and_garage
      data: {}
  mode: single
- id: "1679792693634"
  alias: Button - Garage, control gate and garage door
  description: ""
  use_blueprint:
    path: CrazyCoder/zigbee2mqtt_aqara_wireless_switch.yaml
    input:
      action_sensor: sensor.button_garage_action
      press_single:
        - service: cover.open_cover
          data: {}
          target:
            entity_id:
              - cover.garage_door
              - cover.driveway_gate
      press_hold:
        - service: cover.close_cover
          data: {}
          target:
            entity_id:
              - cover.driveway_gate
              - cover.garage_door
      press_double:
        - service: cover.toggle
          data: {}
          target:
            entity_id: cover.driveway_gate
- id: "1680405230305"
  alias: Octoprint - Start
  description: ""
  trigger:
    - platform: state
      entity_id:
        - sensor.octoprint_current_state
      from: Operational
      to: Printing
  condition: []
  action:
    - service: notify.mobile_app_patricks_iphone_13
      data:
        title: 3D Print Start
        message: 3D print started, turning on workshop fan
        data:
          push:
            sound: HummingbirdCompletion_Haptic.caf
            interruption-level: time-sensitive
    - service: fan.turn_on
      data: {}
      target:
        entity_id: fan.workshop_ceiling_fan
  mode: single
- id: "1680482830475"
  alias: Automatic - Close garage and gate if nobody home more than 2 mins
  description: ""
  trigger:
    - platform: state
      entity_id:
        - cover.driveway_gate
      to: open
      for:
        hours: 0
        minutes: 2
        seconds: 0
    - platform: state
      entity_id:
        - cover.garage_door
      to: open
      for:
        hours: 0
        minutes: 2
        seconds: 0
  condition:
    - condition: state
      entity_id: person.kathleen
      state: not_home
    - condition: state
      entity_id: person.patrick
      state: not_home
  action:
    - service: script.close_gate_and_garage
      data: {}
    - service: notify.mobile_app_patricks_iphone_13
      data:
        message:
          Gate and Garage automatically closed because nobody home more than
          2 mins
        title: Auto close garage and gate
  mode: single
- id: "1680685928321"
  alias: Lights - vacation - all off at approx 10:30pm
  description: ""
  trigger:
    - platform: time
      at: "22:30:00"
  condition: []
  action:
    - delay:
        hours: 0
        minutes: "{{ range(0,30) | random }}"
        seconds: 0
        milliseconds: 0
    - service: light.turn_off
      data: {}
      target:
        entity_id: light.all_lights
    - service: climate.turn_off
      data: {}
      target:
        entity_id: climate.ac
    - service: notify.mobile_app_patricks_iphone_13
      data:
        title: Vacation - lights and A/C off
        message:
          "Turned lights and A/C off a random 30 mins after 10:30pm ({{ now()
          | as_timestamp | timestamp_custom('%I:%M:%S %p') }})

          "
  mode: single
- id: "1681603029589"
  alias: Notify - Washing machine actions
  description: Notify start/finish based on electrical power
  use_blueprint:
    path: sbyx/notify-or-do-something-when-an-appliance-like-a-dishwasher-or-washing-machine-finishes.yaml
    input:
      power_sensor: sensor.washing_machine_current_power
      starting_threshold: 100
      actions:
        - service: notify.patrick_and_kathleen
          data:
            title: Washing machine finish
            message:
              "Washing machine finished - please hang out ({{ (now()) | as_timestamp
              | timestamp_custom('%I:%M %p') }})

              "
        - if:
            - condition: sun
              before: sunset
          then:
            - service: light.turn_on
              data:
                color_name: purple
                brightness_pct: 100
              target:
                entity_id: light.back_lounge_sideboard_lamp
          else:
            - service: light.turn_on
              data:
                color_name: purple
                brightness_pct: 50
              target:
                entity_id: light.back_lounge_sideboard_lamp
        - service: notify.lg_webos_smart_tv
          data:
            title: Washing machine finished
            message:
              Washing machine finished - please hang out ({{ (now()) | as_timestamp
              | timestamp_custom('%I:%M %p') }})
      pre_actions:
        - service: notify.mobile_app_patricks_iphone_13
          data:
            title: Washing machine started
            message: Sit back and relax while the machines do your work!
          enabled: false
      starting_hysteresis: 5
      finishing_threshold: 1
- id: "1681615571224"
  alias: Ensuite fan - control by humidity (notify for testing)
  description: Based on humidity sensor
  trigger:
    - platform: template
      value_template:
        "{% set humid = states('sensor.ensuite_environmental_humidity')|int
        %}

        {% set humid_ave = states('sensor.ensuite_humidity_average_linear_24h')|int
        %}

        {{ humid > humid_ave + 5 }}"
      for:
        hours: 0
        minutes: 0
        seconds: 30
  condition: []
  action:
    - service: notify.mobile_app_patricks_iphone_13
      data:
        title: Ensuite shower
        message:
          Shower is now on because ensuite humidity is 5% above 24hr average
          of {{ states('sensor.ensuite_humidity_average_linear_24h', with_unit=True)
          }}
  mode: single
- id: "1682297014844"
  alias: Ensuite fan - control by humidity
  description: ""
  use_blueprint:
    path: Blackshome/bathroom-humidity-exhaust-fan.yaml
    input:
      trigger: sensor.ensuite_humidity_rate_of_change
      rising_humidity: 3
      falling_humidity: -1.5
      by_pass: sensor.ensuite_humidity_rate_of_change
      include_ha_restart: restart_enabled
      fan_switch:
        entity_id: light.home_security_visualiser_pcb_ensuite_fan_indicator
- id: "1682297394195"
  alias: Ensuite fan - control by humidity (notify for testing)
  description: ""
  trigger:
    - platform: numeric_state
      entity_id: sensor.ensuite_humidity_rate_of_change
      above: 2.7
  condition: []
  action:
    - service: notify.mobile_app_patricks_iphone_13
      data:
        message: Ensuite fan ON
    - wait_for_trigger:
        - platform: numeric_state
          entity_id: sensor.ensuite_humidity_rate_of_change
          below: -1.5
      continue_on_timeout: false
      timeout:
        hours: 0
        minutes: 30
        seconds: 0
        milliseconds: 0
    - service: notify.mobile_app_patricks_iphone_13
      data:
        message: Ensuite fan OFF
  mode: single
- id: "1683635574099"
  alias: Auto off - gas heater when last person leaves home
  description: ""
  trigger:
    - platform: numeric_state
      entity_id: zone.home
      below: 0
  condition: []
  action:
    - service: switch.turn_off
      data: {}
      target:
        entity_id: switch.gas_heater
  mode: single
- id: "1684844548755"
  alias: Notify - Motion in front yard
  description: ""
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.ds_7608ni_i2_8p0820220623ccrrk17144184wcvu_1_linedetection
      to: "on"
    - platform: state
      entity_id:
        - binary_sensor.ds_7608ni_i2_8p0820220623ccrrk17144184wcvu_1_fielddetection
      to: "on"
    - platform: state
      entity_id:
        - binary_sensor.driveway_light_beam
      to: "on"
  condition:
    - condition: state
      entity_id: input_boolean.disable_front_yard_motion_alerts
      state: "off"
    - condition: time
      after: "23:00:00"
      before: 06:00:00
      enabled: true
    - condition: template
      value_template:
        "{{ now() - states.cover.driveway_gate.last_changed > timedelta(seconds=120)
        }}"
    - condition: template
      value_template:
        "{{ now() - states.cover.garage_door.last_changed > timedelta(seconds=120)
        }}"
  action:
    - service: notify.patrick_and_kathleen
      data:
        title: Motion Front Yard
        message: Motion due to {{ trigger.to_state.name }}
        data:
          push:
            sound:
              name: default
              critical: 1
              volume: 0.5
    - delay:
        hours: 0
        minutes: 0
        seconds: 30
        milliseconds: 0
  mode: queued
  max: 10
- id: "1685061501391"
  alias: Input boolean - Enable front yard motion alerts after 1 hour
  description: ""
  trigger:
    - platform: event
      event_type: timer.finished
      event_data:
        entity_id: timer.remaining_time_front_yard_motion_alerts_disabled
  condition:
    - condition: state
      entity_id: input_boolean.disable_front_yard_motion_alerts
      state: "on"
  action:
    - service: input_boolean.turn_off
      data: {}
      target:
        entity_id: input_boolean.disable_front_yard_motion_alerts
  mode: single
- id: "1685061918531"
  alias: Timer - remaining time to enable front yard motion alerts
  description: ""
  trigger:
    - platform: state
      entity_id:
        - input_boolean.disable_front_yard_motion_alerts
  condition: []
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.disable_front_yard_motion_alerts
              state: "on"
          sequence:
            - service: timer.start
              data: {}
              target:
                entity_id: timer.remaining_time_front_yard_motion_alerts_disabled
        - conditions:
            - condition: state
              entity_id: input_boolean.disable_front_yard_motion_alerts
              state: "off"
          sequence:
            - service: timer.finish
              data: {}
              target:
                entity_id: timer.remaining_time_front_yard_motion_alerts_disabled
  mode: single
- id: "1685102688097"
  alias: Input boolean - Enable front yard motion lights after 5 mins
  description: ""
  trigger:
    - platform: event
      event_type: timer.finished
      event_data:
        entity_id: timer.remaining_time_front_yard_motion_lights_disabled
  condition:
    - condition: state
      entity_id: input_boolean.disable_front_yard_motion_lights
      state: "on"
  action:
    - service: input_boolean.turn_off
      data: {}
      target:
        entity_id:
          - input_boolean.disable_front_yard_motion_lights
  mode: single
- id: "1685103116029"
  alias: Timer - remaining time to enable front yard lights
  description: ""
  trigger:
    - platform: state
      entity_id:
        - input_boolean.disable_front_yard_motion_lights
  condition: []
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.disable_front_yard_motion_lights
              state: "on"
          sequence:
            - service: timer.start
              data: {}
              target:
                entity_id:
                  - timer.remaining_time_front_yard_motion_lights_disabled
        - conditions:
            - condition: state
              entity_id: input_boolean.disable_front_yard_motion_lights
              state: "off"
          sequence:
            - service: timer.finish
              data: {}
              target:
                entity_id:
                  - timer.remaining_time_front_yard_motion_lights_disabled
  mode: single
- id: "1685241223269"
  alias: Notify - Yale lock, unlocked with keypad PIN
  description: ""
  trigger:
    - platform: template
      value_template:
        "{{ is_state('sensor.yale_smartlock_front_door_action', 'unlock')
        and is_state('sensor.yale_smartlock_front_door_action_source_name', 'keypad')
        }}

        "
  condition: []
  action:
    - service: notify.mobile_app_patricks_iphone_13
      data:
        title: Yale front door lock
        message: "Unlocked with kaypad PIN

          "
  mode: single
- id: "1688620863158"
  alias: Button - Hall stand
  description: ""
  use_blueprint:
    path: CrazyCoder/zigbee2mqtt_aqara_wireless_switch.yaml
    input:
      action_sensor: sensor.button_hall_stand_action
      press_double:
        - service: cover.open_cover
          data: {}
          target:
            entity_id: cover.pedestrian_gate
        - wait_for_trigger:
            - platform: state
              entity_id:
                - cover.pedestrian_gate
              to: closed
        - service: cover.open_cover
          data: {}
          target:
            entity_id: cover.pedestrian_gate
      press_single:
        - service: cover.open_cover
          data: {}
          target:
            entity_id: cover.pedestrian_gate
- id: "1689412431203"
  alias: Air con turn off timer
  description: ""
  trigger:
    - platform: state
      entity_id:
        - input_number.air_con_off_timer
    - platform: state
      entity_id:
        - input_button.set_air_con_off_timer
  condition: []
  action:
    - service: climate.turn_on
      data: {}
      target:
        entity_id: climate.ac
    - delay:
        hours: 0
        minutes: 0
        seconds: 2
        milliseconds: 0
    - service: advantage_air.set_time_to
      data:
        minutes: "{{ states('input_number.air_con_off_timer') }}

          "
      target:
        entity_id: sensor.ac_time_to_off
  mode: single
- id: "1693651577831"
  alias: Auto off - Pool robot (Shelly) when power drops to zero
  description:
    Robot turns itself off after 2 hrs, even with Shelly switch power applied.
    So this is to turn Shelly output off.
  trigger:
    - platform: numeric_state
      entity_id: sensor.pool_robot_power
      below: 4
      for:
        hours: 0
        minutes: 0
        seconds: 30
  condition: []
  action:
    - service: switch.turn_off
      data: {}
      target:
        entity_id: switch.pool_robot
    - service: notify.mobile_app_patricks_iphone_13
      data:
        title: "Pool robot cleaner \U0001F3CA \U0001F916"
        message:
          Turned off pool cleaner because power dropped below {{ trigger.below
          }} Watts for 30 seconds.
  mode: single
- id: "1693826918399"
  alias: Pool heater - turn ON when grid export power > 2.1kW
  description: ""
  trigger:
    - platform: template
      value_template: "{{ states('sensor.solarnet_power_grid')|float < -2.1 }}"
      id: trigger_power
      for:
        hours: 0
        minutes: 6
        seconds: 0
  condition:
    - condition: state
      entity_id: climate.rostrevor_pool
      state: "off"
    - condition: state
      entity_id: switch.pool_pump
      state: "on"
  action:
    - service: climate.set_hvac_mode
      data:
        hvac_mode: heat
      target:
        entity_id: climate.rostrevor_pool
    - service: climate.turn_on
      data: {}
      target:
        entity_id: climate.rostrevor_pool
    - service: notify.mobile_app_patricks_iphone_13
      data:
        title: Pool heater
        message:
          Turned on pool heater because exporting more than 2.1kW ({{ -(trigger.to_state.state
          | float | round(1)) }}kW) and pump is ON.
  mode: single
- id: "1693827066966"
  alias:
    Pool heater - turn OFF when grid importing for 20 mins or pool pump turns
    OFF
  description: ""
  trigger:
    - platform: numeric_state
      entity_id: sensor.solarnet_power_grid
      for:
        hours: 0
        minutes: 20
        seconds: 0
      above: 0
      id: not enough power
    - platform: state
      entity_id:
        - switch.pool_pump
      to: "off"
      id: pump_off
    - platform: numeric_state
      entity_id: sensor.rostrevor_pool_inlet_water_temp_t02
      above: 27
  condition:
    - condition: state
      entity_id: climate.rostrevor_pool
      state: heat
  action:
    - service: climate.turn_off
      data: {}
      target:
        entity_id: climate.rostrevor_pool
    - choose:
        - conditions:
            - condition: trigger
              id:
                - not enough power
          sequence:
            - service: notify.mobile_app_patricks_iphone_13
              data:
                title: Pool heater
                message:
                  Turned off pool heater because importing power from grid for {{
                  (((trigger.for.seconds) | int) / 60) | round(0) }} minutes.
        - conditions:
            - condition: trigger
              id:
                - pump_off
          sequence:
            - service: notify.mobile_app_patricks_iphone_13
              data:
                title: Pool heater
                message: Turned off pool heater because pump just switched off.
  mode: single
- id: "1694562264439"
  alias: Notify - Consider turn OFF a/c as importing power
  description: ""
  trigger:
    - platform: numeric_state
      entity_id: sensor.solarnet_power_grid
      for:
        hours: 0
        minutes: 20
        seconds: 0
      above: 0
  condition:
    - condition: state
      entity_id: climate.ac
      state: cool
  action:
    - service: notify.mobile_app_patricks_iphone_13
      data:
        title: Air con - consider turning off
        message:
          Consider turning OFF air conditioner as now importing power {{ states('sensor.solarnet_power_grid')
          | float | round(1) }}kW for more than {{ (((trigger.for.seconds) | int) /
          60) | round(0) }} mins
  mode: single
- id: "1694750544303"
  alias: Notify - sump pump ON/OFF
  description: ""
  trigger:
    - platform: numeric_state
      entity_id:
        - sensor.sump_pump_power
      above: 60
      id: power high
    - platform: numeric_state
      entity_id:
        - sensor.sump_pump_power
      below: 10
      id: power low
  condition: []
  action:
    - choose:
        - conditions:
            - condition: trigger
              id:
                - power high
          sequence:
            - service: notify.mobile_app_patricks_iphone_13
              data:
                title: Sump pump!
                message: Sump pump turned ON!
        - conditions:
            - condition: trigger
              id:
                - power low
          sequence:
            - service: notify.mobile_app_patricks_iphone_13
              data:
                title: Sump pump!
                message: Sump pump turned OFF!
  mode: single
- id: "1694818227771"
  alias: Blinds - CLOSE when sunny and hot (based on solar energy for the day at 10AM)
  description: ""
  trigger:
    - platform: time
      at: "10:00:00"
  condition: []
  action:
    - if:
        - condition: numeric_state
          entity_id: sensor.solarnet_energy_day
          above: 9.8
      then:
        - service: notify.mobile_app_patricks_iphone_13
          data:
            title: Closed blinds to reduce heat
            message:
              Closed rear blinds 1, and 3-5 as it's {{ trigger.now | as_timestamp
              | timestamp_custom('%I:%M %p') }} and solar energy for the day is above
              9.8kWh ({{ states('sensor.solarnet_energy_day') | float | round(1) }}kWh).
        - service: cover.close_cover
          data: {}
          target:
            entity_id:
              - cover.blind_3
              - cover.blind_4
              - cover.blind_5
      else:
        - service: notify.mobile_app_patricks_iphone_13
          data:
            title: Didn't close blinds
            message:
              Didn't close rear blinds as at {{ trigger.now | as_timestamp | timestamp_custom('%I:%M
              %p') }} because solar energy for the day was below 9.8kWh ({{ states('sensor.solarnet_energy_day')
              | float | round(1) }}kWh).
  mode: single
- id: "1694846476742"
  alias: Pool pump - ON at 8am or when enough solar (2.1kW) to run heater
  description: ""
  trigger:
    - platform: time
      at: 08:00:00
      id: trigger_time
    - platform: template
      value_template: "{{ states('sensor.solarnet_power_grid')|float < -2.1 }}"
      id: trigger_power
  condition:
    - condition: state
      entity_id: switch.pool_pump
      state: "off"
    - condition: time
      before: "17:00:00"
  action:
    - service: switch.turn_on
      data: {}
      target:
        entity_id: switch.pool_pump
    - choose:
        - conditions:
            - condition: trigger
              id:
                - trigger_time
          sequence:
            - service: notify.mobile_app_patricks_iphone_13
              data:
                title: Pool pump turned ON
                message:
                  Pool pump turned ON because it's {{ trigger.now | as_timestamp
                  | timestamp_custom('%I:%M %p') }}
        - conditions:
            - condition: trigger
              id:
                - trigger_power
          sequence:
            - service: notify.mobile_app_patricks_iphone_13
              data:
                title: Pool pump turned ON
                message:
                  Pool pump turned ON because because exporting enough power to run
                  heater too ({{ -(trigger.to_state.state | float | round(2)) }}kW)
  mode: single
- id: "1694847669808"
  alias: Pool pump - OFF at 5pm
  description: ""
  trigger:
    - platform: time
      at: "17:00:00"
      id: trigger_time
  condition: []
  action:
    - service: switch.turn_off
      data: {}
      target:
        entity_id: switch.pool_pump
    - service: notify.mobile_app_patricks_iphone_13
      data:
        title: Pool pump turned OFF
        message:
          Pool pump turned OFF because it's {{ trigger.now | as_timestamp | timestamp_custom('%I:%M
          %p') }}
  mode: single
- id: "1695041517610"
  alias: Air con ON when HOT back lounge (nobody at home)
  description: ""
  trigger:
    - platform: numeric_state
      entity_id: climate.ac_back_lounge
      attribute: current_temperature
      above: 26
  condition:
    - condition: numeric_state
      entity_id: sensor.solarnet_power_grid
      below: -5
    - condition: numeric_state
      entity_id: zone.home
      below: 1
  action:
    - service: climate.turn_on
      data: {}
      target:
        entity_id: climate.ac
    - service: climate.set_temperature
      data:
        temperature: 24
        hvac_mode: cool
      target:
        entity_id: climate.ac
    - service: climate.set_hvac_mode
      data:
        hvac_mode: cool
      target:
        entity_id: climate.ac
      enabled: true
    - service: climate.set_fan_mode
      data:
        fan_mode: medium
      target:
        entity_id: climate.ac
    - service: notify.mobile_app_patricks_iphone_13
      data:
        title: Air con turned on (Nobody at home)
        message:
          Turned on air conditioner as {{ trigger.to_state.name }} temperature
          is above {{ trigger.above }} and exporting more than 5kW (nobody is home)
    - service: climate.set_temperature
      data:
        temperature: 24
      target:
        entity_id:
          - climate.ac_back_lounge
          - climate.ac_entry
          - climate.ac_front_lounge
          - climate.ac_jess_br
          - climate.ac_kitchen
          - climate.ac_master_br
          - climate.ac_spare_br
          - climate.ac_workshop
  mode: single
- id: "1695267626675"
  alias: "Blinds - open all (except #1) in the afternoon when sun < 25°"
  description: ""
  trigger:
    - platform: numeric_state
      entity_id: sun.sun
      attribute: elevation
      below: 25
  condition: []
  action:
    - service: cover.open_cover
      data: {}
      target:
        entity_id:
          - cover.blind_2
          - cover.blind_3
          - cover.blind_4
          - cover.blind_5
  mode: single
- id: "1695452208621"
  alias: Gate - close automatically after car passes through
  description: ""
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.driveway_light_beam
      to: "on"
      for:
        hours: 0
        minutes: 0
        seconds: 2
  condition:
    - condition: template
      value_template:
        "  {{ as_timestamp(now()) - as_timestamp(states.sensor.button_garage_action.last_changed)
        < 360 }}"
      enabled: true
  action:
    - wait_for_trigger:
        - platform: state
          entity_id:
            - binary_sensor.driveway_light_beam
          to: "off"
      timeout:
        hours: 0
        minutes: 5
        seconds: 0
        milliseconds: 0
    - delay:
        hours: 0
        minutes: 0
        seconds: 2
        milliseconds: 0
      enabled: true
    - service: cover.close_cover
      data: {}
      target:
        entity_id:
          - cover.driveway_gate
          - cover.garage_door
  mode: single
- id: "1696560418641"
  alias: Blinds - open blind 1 just before sunset
  description: ""
  trigger:
    - platform: numeric_state
      entity_id: sun.sun
      attribute: elevation
      below: 3.5
  condition: []
  action:
    - service: cover.open_cover
      data: {}
      target:
        entity_id:
          - cover.blind_1
  mode: single
- id: "1696932809329"
  alias: Blinds - close at 10:30AM if kitchen hot (>22C)
  description: ""
  trigger:
    - platform: time
      at: "10:30:00"
  condition:
    - condition: numeric_state
      entity_id: climate.ac_kitchen
      attribute: current_temperature
      above: 22
    - condition: numeric_state
      entity_id: sensor.solarnet_energy_day
      above: 9
  action:
    - service: notify.mobile_app_patricks_iphone_13
      data:
        title: Closed blinds to reduce heat
        message:
          Closed rear blinds 1, and 3-5 as it's {{ trigger.now | as_timestamp
          | timestamp_custom('%I:%M %p') }} and kitchen temperature is above 22°C  ({{
          state_attr('climate.ac_kitchen', 'current_temperature') | float | round(1)
          }}°C), solar energy for the day is above 9.0kWh ({{ states('sensor.solarnet_energy_day')
          | float | round(1) }}kWh)
    - service: cover.close_cover
      data: {}
      target:
        entity_id:
          - cover.blind_1
          - cover.blind_3
          - cover.blind_4
          - cover.blind_5
  mode: single
- id: "1697950024288"
  alias: Light - front hall lamp RED when front door / gate open or unlocked 15 mins
  description: ""
  trigger:
    - platform: state
      entity_id:
        - lock.yale_smartlock_front_door
      to: unlocked
      for:
        hours: 0
        minutes: 15
        seconds: 0
      id: front door lock
    - platform: state
      entity_id:
        - binary_sensor.front_door_aqara_contact
      to: "on"
      for:
        hours: 0
        minutes: 15
        seconds: 0
      id: front door
    - platform: state
      entity_id:
        - cover.garage_door
      to: open
      for:
        hours: 0
        minutes: 15
        seconds: 0
      id: garage door
    - platform: state
      entity_id:
        - cover.driveway_gate
      for:
        hours: 0
        minutes: 15
        seconds: 0
      to: open
      id: driveway gate
  condition: []
  action:
    - service: light.turn_on
      data:
        rgb_color:
          - 255
          - 0
          - 0
        brightness_pct: 100
      target:
        entity_id: light.front_hall_lamp
    - choose:
        - conditions:
            - condition: trigger
              id:
                - front door lock
          sequence:
            - service: notify.mobile_app_patricks_iphone_13
              data:
                title: Security alert!
                message:
                  Front door has been unlocked for {{ (((trigger.for.seconds) | int)
                  / 60) | round(0) }} minutes. Will try and lock it now, but please double
                  check it.
                data:
                  push:
                    sound:
                      name: default
                      critical: 1
                      volume: 0.5
            - service: tts.cloud_say
              data:
                entity_id:
                  - media_player.homepod_mini_back_lounge
                  - media_player.workshop_speaker
                message:
                  Front door has been unlocked for {{ (((trigger.for.seconds) | int)
                  / 60) | round(0) }} minutes. Will try and lock it now, but please double
                  check it.
            - service: lock.lock
              data: {}
              target:
                entity_id: lock.yale_smartlock_front_door
        - conditions:
            - condition: trigger
              id:
                - front door
          sequence:
            - service: notify.mobile_app_patricks_iphone_13
              data:
                title: Security alert!
                message:
                  Front door has been open for {{ (((trigger.for.seconds) | int)
                  / 60) | round(0) }} minutes. Please go and close it.
                data:
                  push:
                    sound:
                      name: default
                      critical: 1
                      volume: 0.5
            - service: tts.cloud_say
              data:
                entity_id:
                  - media_player.homepod_mini_back_lounge
                  - media_player.workshop_speaker
                message:
                  Front door has been open for {{ (((trigger.for.seconds) | int)
                  / 60) | round(0) }} minutes. Please go and close it.
        - conditions:
            - condition: trigger
              id:
                - garage door
            - condition: state
              entity_id: input_boolean.garage_door_alerts
              state: "on"
          sequence:
            - service: notify.mobile_app_patricks_iphone_13
              data:
                title: Security alert!
                message:
                  Garage door has been open for {{ (((trigger.for.seconds) | int)
                  / 60) | round(0) }} minutes. Please go and close it.
                data:
                  push:
                    sound:
                      name: default
                      critical: 1
                      volume: 0.5
            - service: tts.cloud_say
              data:
                entity_id:
                  - media_player.homepod_mini_back_lounge
                  - media_player.workshop_speaker
                message:
                  Garage door has been open for {{ (((trigger.for.seconds) | int)
                  / 60) | round(0) }} minutes. Please go and close it.
        - conditions:
            - condition: trigger
              id:
                - driveway gate
          sequence:
            - service: notify.mobile_app_patricks_iphone_13
              data:
                title: Security alert!
                message:
                  Driveway gate has been open for {{ (((trigger.for.seconds) | int)
                  / 60) | round(0) }} minutes. Please go and close it.
                data:
                  push:
                    sound:
                      name: default
                      critical: 1
                      volume: 0.5
            - service: tts.cloud_say
              data:
                entity_id:
                  - media_player.homepod_mini_back_lounge
                  - media_player.workshop_speaker
                message:
                  Driveway gate has been open for {{ (((trigger.for.seconds) | int)
                  / 60) | round(0) }} minutes. Please go and close it.
  mode: single
- id: "1697960300615"
  alias: Light - front hall lamp REMOVE RED when front door / gate closed
  description: ""
  trigger:
    - platform: state
      entity_id:
        - lock.yale_smartlock_front_door
      to: locked
      for:
        hours: 0
        minutes: 0
        seconds: 0
    - platform: state
      entity_id:
        - binary_sensor.front_door_aqara_contact
      to: "off"
      for:
        hours: 0
        minutes: 0
        seconds: 0
    - platform: state
      entity_id:
        - cover.garage_door
      to: closed
      for:
        hours: 0
        minutes: 0
        seconds: 0
    - platform: state
      entity_id:
        - cover.driveway_gate
      to: closed
  condition:
    - condition: template
      value_template: "{{ is_state_attr('light.front_hall_lamp' , 'rgb_color' ,
        (255, 0, 0)) }}"
  action:
    - if:
        - condition: state
          entity_id: light.led_strip_front_hall_dimmer
          state: "on"
      then:
        - service: light.turn_on
          data:
            color_temp: 358
            brightness_pct: 40
          target:
            entity_id: light.front_hall_lamp
      else:
        - service: light.turn_off
          data: {}
          target:
            entity_id: light.front_hall_lamp
  mode: single
- id: "1698489586090"
  alias: Button - washing machine
  description: Turn off PURPLE washing machine light
  use_blueprint:
    path: CrazyCoder/zigbee2mqtt_aqara_wireless_switch.yaml
    input:
      action_sensor: sensor.button_washing_machine_action
      press_double:
        - service: light.toggle
          data: {}
          target:
            entity_id:
              - light.laundry_downlight
              - light.laundry_path_bunker_light
      press_single:
        - if:
            - condition: or
              conditions:
                - condition: numeric_state
                  entity_id: sun.sun
                  attribute: elevation
                  above: 5
                - condition: state
                  entity_id: input_boolean.sleep_mode
                  state: ""
          then:
            - service: light.turn_on
              data:
                kelvin: 2900
                brightness_pct: 40
              target:
                entity_id: light.back_lounge_sideboard_lamp
            - service: light.turn_off
              data: {}
              target:
                entity_id: light.back_lounge_sideboard_lamp
          else:
            - if: []
              then:
                - service: light.turn_on
                  data:
                    brightness_pct: 35
                    kelvin: 2900
                  target:
                    entity_id: light.back_lounge_sideboard_lamp
- id: "1698533404217"
  alias: Motion - butlers pantry lights v2
  description: ""
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.butlers_sensor_occupancy
      to: "on"
      id: motion detected
    - platform: state
      entity_id:
        - binary_sensor.butlers_sensor_occupancy
      to: "off"
      id: no motion
      for:
        hours: 0
        minutes: 4
        seconds: 0
  condition: []
  action:
    - if:
        - condition: trigger
          id:
            - motion detected
      then:
        - if:
            - condition: state
              entity_id: input_boolean.sleep_mode
              state: "on"
          then:
            - service: light.turn_on
              data:
                brightness_pct: 2
              target:
                entity_id:
                  - light.led_strip_butlers_overhead_cupboards
          else:
            - service: light.turn_on
              data:
                brightness_pct: 50
              target:
                entity_id:
                  - light.butlers_downlight
                  - light.led_strip_butlers_overhead_cupboards
      else:
        - service: light.turn_off
          data: {}
          target:
            entity_id:
              - light.butlers_downlight
              - light.led_strip_butlers_overhead_cupboards
  mode: single
- id: "1698534798412"
  alias: Motion - WIR downlights
  description: ""
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.wir_sensor_occupancy
      to: "on"
      id: motion detected
    - platform: state
      entity_id:
        - binary_sensor.wir_sensor_occupancy
      to: "off"
      for:
        hours: 0
        minutes: 2
        seconds: 0
  condition: []
  action:
    - if:
        - condition: trigger
          id:
            - motion detected
      then:
        - if:
            - condition: state
              entity_id: input_boolean.sleep_mode
              state: "on"
          then:
            - service: light.turn_on
              data:
                brightness_pct: 7
              target:
                entity_id: light.wir_downlight
          else:
            - service: light.turn_on
              data:
                brightness_pct: 100
              target:
                entity_id: light.wir_downlight
      else:
        - service: light.turn_off
          data: {}
          target:
            entity_id: light.wir_downlight
  mode: single
- id: "1698537751935"
  alias: Motion - Hallway turn lights v2
  description: ""
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.hallway_sensor_occupancy
      to: "on"
      id: motion detected
    - platform: state
      entity_id:
        - binary_sensor.hallway_sensor_occupancy
      to: "off"
      for:
        hours: 0
        minutes: 2
        seconds: 40
      enabled: false
  condition:
    - condition: state
      entity_id: input_boolean.sleep_mode
      state: "on"
  action:
    - if:
        - condition: trigger
          id:
            - motion detected
      then:
        - service: light.turn_on
          data:
            brightness_pct: 5
          target:
            entity_id: light.led_strip_kitchen_kicker
        - service: light.turn_on
          data:
            brightness_step_pct: 10
          target:
            entity_id: light.led_strip_front_hall_dimmer
      else:
        - service: light.turn_off
          data: {}
          target:
            entity_id:
              - light.led_strip_kitchen_kicker
              - light.led_strip_front_hall_dimmer
      enabled: false
    - service: light.turn_on
      data:
        brightness_pct: 10
      target:
        entity_id: light.led_strip_front_hall_dimmer
    - service: light.turn_on
      data:
        brightness_pct: 5
      target:
        entity_id: light.led_strip_kitchen_kicker
    - service: light.turn_on
      data:
        effect: 1 Tropical
        brightness_pct: 30
      target:
        entity_id: light.twinkly_back_lounge
    - delay:
        hours: 0
        minutes: 2
        seconds: 45
        milliseconds: 0
    - service: light.turn_off
      data: {}
      target:
        entity_id:
          - light.led_strip_kitchen_kicker
          - light.led_strip_front_hall_dimmer
          - light.twinkly_back_lounge
  mode: single
- id: "1698538309359"
  alias: Motion - garage lights
  description: ""
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.garage_sensor_occupancy
      to: "on"
      id: motion detected
    - platform: state
      entity_id:
        - cover.garage_door
      to: opening
      id: motion detected
    - platform: state
      entity_id:
        - binary_sensor.garage_sensor_occupancy
      to: "off"
      for:
        hours: 0
        minutes: 7
        seconds: 0
    - platform: state
      entity_id:
        - cover.garage_door
      to: closed
      for:
        hours: 0
        minutes: 7
        seconds: 0
  condition: []
  action:
    - if:
        - condition: trigger
          id:
            - motion detected
      then:
        - service: light.turn_on
          data: {}
          target:
            entity_id: light.garage_downlights
      else:
        - service: light.turn_off
          data: {}
          target:
            entity_id: light.garage_downlights
  mode: single
- id: "1699674375223"
  alias: Notify - leaving home
  description: ""
  trigger:
    - platform: state
      entity_id:
        - device_tracker.patricks_iphone_13
      to: not_home
  condition: []
  action:
    - service: notify.mobile_app_patricks_iphone_13
      data:
        title: Left Home
        message: You just left Home zone
  mode: single
- id: "1699674451832"
  alias: Notify - arrive home
  description: ""
  trigger:
    - platform: state
      entity_id:
        - device_tracker.patricks_iphone_13
      to: home
      id: iphone zone
    - platform: state
      entity_id:
        - device_tracker.patricks_iphone_bluetooth
      to: home
      id: BLE tracker
    - platform: state
      entity_id:
        - sensor.patricks_iphone_13_connection_type
      to: Wi-Fi
      id: wifi connected
      enabled: false
  condition: []
  action:
    - choose:
        - conditions:
            - condition: trigger
              id:
                - iphone zone
          sequence:
            - service: notify.mobile_app_patricks_iphone_13
              data:
                title: Arrived Home - Geolocation
                message:
                  You just arrived in Home zone - triggered by iPhone geolocation
                  ({{ (now()) | as_timestamp | timestamp_custom('%I:%M:%S %p') }})
        - conditions:
            - condition: trigger
              id:
                - BLE tracker
          sequence:
            - service: notify.mobile_app_patricks_iphone_13
              data:
                title: Arrived Home - BLE Proxy
                message:
                  You just arrived home - triggered by BLE proxy tracker (Olimex
                  PoE) ({{ (now()) | as_timestamp | timestamp_custom('%I:%M:%S %p') }})
        - conditions:
            - condition: trigger
              id:
                - wifi connected
          sequence:
            - service: notify.mobile_app_patricks_iphone_13
              data:
                title: Arrived Home - Wi-Fi
                message:
                  You just arrived home - triggered by WiFi connection ({{ (now())
                  | as_timestamp | timestamp_custom('%I:%M:%S %p') }})
  mode: single
- id: "1699759355459"
  alias: Light - workshop 16x16 matrix ON
  description: ""
  trigger:
    - platform: state
      entity_id:
        - light.workshop_downlight
      to: "on"
  condition: []
  action:
    - service: light.turn_on
      target:
        entity_id: light.wled_16x16_matrix
      data:
        effect:
          "{{ state_attr('light.wled_16x16_matrix', 'effect_list') | random
          }}"
  mode: single
- id: "1699759417101"
  alias: Light - workshop 16x16 RGB matrix OFF after 30 mins
  description: ""
  trigger:
    - platform: state
      entity_id:
        - light.wled_16x16_matrix
      to: "on"
      for:
        hours: 0
        minutes: 30
        seconds: 0
    - platform: state
      entity_id:
        - light.led_strip_workshop_shelf_dimmer
      to: "off"
      for:
        hours: 0
        minutes: 30
        seconds: 0
  condition: []
  action:
    - service: light.turn_off
      data: {}
      target:
        entity_id: light.wled_16x16_matrix
  mode: single
- id: "1701770661634"
  alias: Light - twinkly xmas lights random effect every 10 minutes
  description: ""
  trigger:
    - platform: time_pattern
      minutes: /10
  condition:
    - condition: numeric_state
      entity_id: sun.sun
      attribute: elevation
      below: 5
    - condition: state
      entity_id: input_boolean.sleep_mode
      state: "off"
  action:
    - service: light.turn_on
      data:
        effect: "{{ range(0,6) | random | int }}"
      target:
        entity_id: light.twinkly_back_lounge
  mode: single
- id: "1701857008891"
  alias: Xmas - snow village ON at 8:30pm
  description: ""
  trigger:
    - platform: time
      at: "20:30:00"
  condition: []
  action:
    - service: light.turn_on
      target:
        entity_id:
          - light.xmas_village
        device_id: []
        area_id: []
      data: {}
  mode: single
- id: "1701857080434"
  alias: Xmas - snow village OFF at 9:00pm
  description: ""
  trigger:
    - platform: time
      at: "21:00:00"
  condition: []
  action:
    - service: light.turn_off
      data: {}
      target:
        entity_id: light.xmas_village
  mode: single
- id: "1701990925626"
  alias: Notify - eMTB charger
  description: ""
  trigger:
    - platform: numeric_state
      entity_id:
        - sensor.emtb_charger_current_power
      id: start
      above: 5
    - platform: numeric_state
      entity_id:
        - sensor.emtb_charger_current_power
      below: 5
      for:
        hours: 0
        minutes: 1
        seconds: 0
      id: finish
  condition: []
  action:
    - choose:
        - conditions:
            - condition: trigger
              id:
                - start
          sequence:
            - service: notify.mobile_app_patricks_iphone_13
              data:
                title: eMTB charge started
                message:
                  Started eMTB charging ({{ now() | as_timestamp | timestamp_custom('%I:%M:%S
                  %p') }})
            - service: input_datetime.set_datetime
              target:
                entity_id: input_datetime.emtb_charge_start
              data:
                datetime: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"
        - conditions:
            - condition: trigger
              id:
                - finish
          sequence:
            - service: notify.mobile_app_patricks_iphone_13
              data:
                title: eMTB charge finished
                message:
                  "Charge power has dropped below {{ trigger.below }}W for {{ (((trigger.for.seconds)
                  | int) / 60) | round(0) }} minutes, so turned OFF charger ({{ now() |
                  as_timestamp | timestamp_custom('%I:%M:%S %p') }}). Total charge time
                  was "
            - service: switch.turn_off
              target:
                entity_id: switch.emtb_charger
              data: {}
              enabled: true
  mode: single
- id: "1702902190318"
  alias: Max day solar - update value and date
  description: ""
  trigger:
    - platform: state
      entity_id:
        - sensor.solarnet_energy_day
  condition:
    - condition: numeric_state
      entity_id: sensor.solarnet_energy_day
      above: input_number.max_day_solar_amount
  action:
    - service: input_number.set_value
      target:
        entity_id: input_number.max_day_solar_amount
      data:
        value: "{{ trigger.to_state.state | float(0) | round(1) }}"
    - service: input_datetime.set_datetime
      target:
        entity_id: input_datetime.max_day_solar_date
      data:
        date: "{{ now().strftime('%Y-%m-%d') }}"
    - service: notify.mobile_app_patricks_iphone_13
      data:
        title: New day solar maximum ths year!
        message:
          Just made a new maximum daily solar this year of {{ trigger.to_state.state
          | float(0) | round(1) }} kWh
  mode: single
